# Database Schema

## Overview

PostgreSQL database hosted on Neon Serverless. Uses SQLModel for Python ORM integration with FastAPI.

## Connection

```
DATABASE_URL=postgresql://user:password@host.neon.tech/dbname?sslmode=require
```

## Tables

### users

Managed by Better Auth. Contains user authentication data.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | UUID generated by Better Auth |
| email | VARCHAR(255) | UNIQUE, NOT NULL | User's email address |
| email_verified | BOOLEAN | DEFAULT FALSE | Email verification status |
| name | VARCHAR(255) | NULL | Display name (optional) |
| image | TEXT | NULL | Profile image URL (optional) |
| created_at | TIMESTAMP | DEFAULT NOW() | Account creation time |
| updated_at | TIMESTAMP | DEFAULT NOW() | Last update time |

**Indexes:**
- `idx_users_email` on `email` (for login lookup)

---

### sessions

Managed by Better Auth. Stores active user sessions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | VARCHAR(36) | PRIMARY KEY | Session UUID |
| user_id | VARCHAR(36) | FOREIGN KEY → users.id | Owner of session |
| token | TEXT | NOT NULL | Session token |
| expires_at | TIMESTAMP | NOT NULL | Expiration time |
| ip_address | VARCHAR(45) | NULL | Client IP |
| user_agent | TEXT | NULL | Client user agent |
| created_at | TIMESTAMP | DEFAULT NOW() | Session creation time |

**Indexes:**
- `idx_sessions_user_id` on `user_id`
- `idx_sessions_token` on `token`

---

### tasks

Core task storage table.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-increment task ID |
| user_id | VARCHAR(36) | FOREIGN KEY → users.id, NOT NULL | Task owner |
| title | VARCHAR(200) | NOT NULL | Task title |
| description | TEXT | NULL | Optional description |
| completed | BOOLEAN | DEFAULT FALSE | Completion status |
| priority | VARCHAR(10) | DEFAULT 'medium' | Priority: high/medium/low |
| created_at | TIMESTAMP | DEFAULT NOW() | Creation time |
| updated_at | TIMESTAMP | DEFAULT NOW() | Last update time |

**Indexes:**
- `idx_tasks_user_id` on `user_id` (for filtering by user)
- `idx_tasks_completed` on `completed` (for status filtering)
- `idx_tasks_priority` on `priority` (for priority filtering)
- `idx_tasks_created_at` on `created_at` (for sorting)

**Constraints:**
- `chk_priority` CHECK (priority IN ('high', 'medium', 'low'))
- `fk_tasks_user` FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE

---

### tags

Stores unique tag names per user.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | SERIAL | PRIMARY KEY | Auto-increment tag ID |
| user_id | VARCHAR(36) | FOREIGN KEY → users.id, NOT NULL | Tag owner |
| name | VARCHAR(50) | NOT NULL | Tag name |
| created_at | TIMESTAMP | DEFAULT NOW() | Creation time |

**Indexes:**
- `idx_tags_user_id` on `user_id`
- `idx_tags_name` on `name`

**Constraints:**
- `uq_tags_user_name` UNIQUE (user_id, name) — Each user can only have one tag with a given name

---

### task_tags

Junction table for many-to-many relationship between tasks and tags.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| task_id | INTEGER | FOREIGN KEY → tasks.id | Task reference |
| tag_id | INTEGER | FOREIGN KEY → tags.id | Tag reference |

**Constraints:**
- PRIMARY KEY (task_id, tag_id)
- `fk_task_tags_task` FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE
- `fk_task_tags_tag` FOREIGN KEY (tag_id) REFERENCES tags(id) ON DELETE CASCADE

---

## Entity Relationships

```
users (1) ←──────────────── (N) sessions
  │
  ├─── (1) ←──────────────── (N) tasks
  │                              │
  │                              └─── (N) ←── task_tags ──→ (N) tags
  │
  └─── (1) ←──────────────── (N) tags
```

## SQLModel Definitions

### User Model
```python
class User(SQLModel, table=True):
    __tablename__ = "users"

    id: str = Field(primary_key=True)
    email: str = Field(unique=True, index=True)
    name: str | None = None
    created_at: datetime = Field(default_factory=datetime.utcnow)

    tasks: list["Task"] = Relationship(back_populates="user")
    tags: list["Tag"] = Relationship(back_populates="user")
```

### Task Model
```python
class Task(SQLModel, table=True):
    __tablename__ = "tasks"

    id: int | None = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="users.id", index=True)
    title: str = Field(max_length=200)
    description: str | None = None
    completed: bool = Field(default=False)
    priority: str = Field(default="medium")
    created_at: datetime = Field(default_factory=datetime.utcnow)
    updated_at: datetime = Field(default_factory=datetime.utcnow)

    user: User = Relationship(back_populates="tasks")
    tags: list["Tag"] = Relationship(back_populates="tasks", link_model=TaskTag)
```

### Tag Model
```python
class Tag(SQLModel, table=True):
    __tablename__ = "tags"

    id: int | None = Field(default=None, primary_key=True)
    user_id: str = Field(foreign_key="users.id", index=True)
    name: str = Field(max_length=50)
    created_at: datetime = Field(default_factory=datetime.utcnow)

    user: User = Relationship(back_populates="tags")
    tasks: list["Task"] = Relationship(back_populates="tags", link_model=TaskTag)
```

## Migrations

Use Alembic for database migrations:

```bash
# Generate migration
alembic revision --autogenerate -m "description"

# Apply migrations
alembic upgrade head

# Rollback
alembic downgrade -1
```

## Data Integrity

### Cascade Deletes
- Deleting a user cascades to delete all their tasks, tags, and sessions
- Deleting a task cascades to delete all task_tag associations
- Deleting a tag cascades to delete all task_tag associations

### User Isolation
- All queries MUST include `WHERE user_id = <authenticated_user_id>`
- Never expose data from other users
- Validate user ownership before any update/delete operation
